# ATS — Automated Forex Trading System v3

RSI + AutoTrend strategy with full risk management, deployed via TradingView webhooks to OANDA.
Includes Next.js dashboard, SQLite persistence, backtesting engine, and ForexFactory news integration.

## Architecture

```
 TradingView                    VPS Server                           Browser
┌──────────┐    Webhook    ┌──────────────────────────────────┐   ┌──────────────┐
│Pine Script│───────────────│  FastAPI Server (port 8000)      │   │  Next.js     │
│ RSI + AT  │    JSON POST  │  ┌────────────┐ ┌─────────────┐ │   │  Dashboard   │
└──────────┘               │  │  Webhook   │ │  REST API   │◄├───┤  (port 3000) │
                           │  │  Handler   │ │  /api/*     │ │   │              │
ForexFactory               │  └─────┬──────┘ └──────┬──────┘ │   └──────────────┘
┌──────────┐    JSON       │        │                │        │
│ Calendar │◄──────────────│  ┌─────▼────────────────▼──────┐ │
└──────────┘    (cached)   │  │       Rule Engine            │ │
                           │  │  Correlation │ Market Hours  │ │
OANDA                      │  │  News Filter │ Loss Streak   │ │
┌──────────┐    v20 API    │  └─────────────┬───────────────┘ │
│ Execute  │◄──────────────│                │                 │
│ Manage   │               │  ┌─────────────▼───────────────┐ │
└──────────┘               │  │       SQLite Database        │ │
                           │  │  trades│signals│logs│settings│ │
                           │  └─────────────────────────────┘ │
                           │                                   │
                           │  ┌───────────────────────────────┐│
                           │  │    Backtest Engine (offline)   ││
                           │  │  CSV data → simulated trades   ││
                           │  └───────────────────────────────┘│
                           └──────────────────────────────────┘
```

## Quick Start

### 1. Backend
```bash
cd forex_trading_system
pip install -r requirements.txt
python -m server.api
# → Server running on http://localhost:8000
# → Docs at http://localhost:8000/docs (auto-generated by FastAPI)
```

### 2. Frontend
### Testing External Signals
```bash
python test_external_signals.py
# → Tests signal fetching from configured providers
```

### 3. Environment Variables

The `.env` file in the project root is already configured with OANDA demo credentials and loaded automatically via `python-dotenv`.

```bash
# .env file in project root
OANDA_API_KEY=<configured>             # OANDA v20 API key (practice account)
OANDA_ACCOUNT_ID=<configured>          # OANDA account ID (101-001-***-001)
ATS_DB_PATH=data/ats_trading.db        # optional, defaults to this
PORT=8000                              # optional
```

> **Status:** OANDA demo account is **connected and live**. Account data, open trades, and balance are streamed to the dashboard in real-time.

## Project Structure

```
forex_trading_system/
├── server/
│   ├── api.py              ← FastAPI server (webhook + REST API)
│   └── webhook_server.py   ← Legacy Flask server (kept for reference)
├── core/
│   ├── rule_engine.py      ← Central decision maker
│   ├── correlation_filter.py ← Prevents duplicate exposure
│   ├── market_hours.py     ← Session open / weekend filter
│   ├── position_manager.py ← Partial close + trailing stop
│   └── state_manager.py    ← Loss streak / cooldown tracker
├── database/
│   └── db.py               ← SQLite schema + queries
├── news/
│   └── forex_factory.py    ← ForexFactory JSON scraper
├── brokers/
│   └── oanda.py            ← OANDA v20 API client
├── backtest/
│   └── engine.py           ← Full backtesting engine
├── config/
│   └── settings.py         ← All configurable parameters
├── pine_scripts/
│   ├── ats_rsi_strategy_v2.pine  ← TradingView strategy
│   └── rsi_autotrend_strategy.pine
├── frontend/               ← Next.js dashboard
│   ├── src/app/            ← Pages
│   ├── src/components/     ← UI panels
│   └── src/lib/            ← API client, hooks, mock data
└── requirements.txt
```

## API Endpoints

### Webhook
| Method | Path | Description |
|--------|------|-------------|
| POST | `/webhook` | TradingView alert receiver |

### Dashboard
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/account` | OANDA account summary (balance, NAV, margin, P&L) |
| GET | `/api/status` | System status (bot state, sessions, streaks) |
| GET | `/api/trades/open` | Current open positions (live from OANDA) |
| GET | `/api/trades/history` | Closed trade history |
| POST | `/api/trades/close` | Close a trade on OANDA + DB |
| POST | `/api/trades/close-all` | Emergency close all positions |
| POST | `/api/trades/modify` | Modify SL/TP/trailing on open trade |
| GET | `/api/performance` | Win rate, P&L, equity curve |
| GET | `/api/signals` | Recent webhook signals (approved + rejected) |
| GET | `/api/equity-curve` | Equity curve data |
| GET | `/api/activity` | Activity log |

### External Signals
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/external-signals` | Fetch external signals from providers |
| POST | `/api/external-signals/fetch` | Refresh signals from all providers |
| POST | `/api/external-signals/import` | Import high-confidence signals to DB |

## External Signal Providers

The system can integrate signals from various external platforms:

### Supported Providers
- **TradingView** - Technical analysis signals
- **ForexSignals.com** - Professional signal service
- **ZuluTrade** - Social trading platform
- **Myfxbook** - Signal provider rankings

### Configuration
Edit `config/signal_providers.py` to add API keys:

```python
SIGNAL_PROVIDER_CONFIG = {
    "zulutrade": {
        "api_key": "your_zulutrade_api_key",
        "enabled": True,
        "min_confidence": 0.7,
    },
    # ... other providers
}
```

### Usage
1. **Fetch Signals**: Click "FETCH" in the Signals panel to get latest signals
2. **View Signals**: Toggle "EXTERNAL" to see signals from providers
3. **Import Signals**: Click "IMPORT" to add high-confidence signals to your system

### Signal Quality
- Signals are filtered by confidence score
- Only signals passing your rule engine are executed
- External signals are marked with provider name and confidence percentage

## News (ForexFactory)
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/news` | Upcoming economic events |
| GET | `/api/news/today` | Today's high-impact events |
| GET | `/api/news/check/{pair}` | Can we trade this pair right now? |

### Settings
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/settings` | Current config values |
| PUT | `/api/settings` | Update config at runtime |

### Backtest
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/backtest/runs` | Previous backtest results |
| POST | `/api/backtest/run` | Trigger a single-pair backtest |
| POST | `/api/backtest/run-multi` | Multi-pair portfolio backtest |

### Health
| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Component health check |

## Backtesting

### From CLI
```bash
python -m backtest.engine --pair EUR_USD --csv data/EURUSD_M15.csv --start 2024-01-01 --end 2025-12-31
```

### From Dashboard
POST to `/api/backtest/run?pair=EUR_USD&start_date=2024-01-01&end_date=2025-12-31`

### Data Format
Place M15 OHLCV CSV files in `data/backtest/`:
```
data/backtest/EUR_USD_M15.csv
data/backtest/GBP_USD_M15.csv
```

CSV format (TradingView export works directly):
```csv
time,open,high,low,close,volume
2024-01-02T00:00:00,1.10450,1.10512,1.10389,1.10478,1234
```

### What the Backtest Simulates
- AutoTrend direction (EMA crossover proxy)
- RSI 14 oversold/overbought signals
- H1 trend confirmation
- Correlation filter (no duplicate pairs)
- Market hours (skip session opens, weekends)
- Loss streak cooldown (4 losses → 6hr pause)
- Partial close at 1.9R target + 2-pip trailing stop
- Spread + slippage costs per pair

## Trading Rules

1. **Signal**: RSI crosses 30 (buy) or 70 (sell) + AutoTrend agrees
2. **HTF Confirmation**: H1 trend same direction as M15 signal
3. **Pair Allowed**: Must be in the 7 major pairs list
4. **Market Hours**: Not within 15min of London/NY/Tokyo/Sydney open
5. **News Filter**: No trades 30min before/after high-impact ForexFactory events
6. **Correlation**: No duplicate exposure (EUR/USD + GBP/USD both long = blocked)
7. **Max Positions**: 3 simultaneous trades max
8. **Loss Streak**: 4 consecutive losses → 6-hour cooldown

## Configuration Presets

- **Default**: 1% risk, 1.9:1 R:R, ATR stop, 3 max trades
- **Conservative**: 0.5% risk, 2.0:1 R:R, 2 max trades, 8hr cooldown
- **Aggressive**: 2% risk, 1.5:1 R:R, 4 max trades, 4hr cooldown

## TODO

- [x] Connect OANDA account (demo connected, live data flowing)
- [x] Wire all frontend panels to real API (SWR hooks, mock fallback)
- [x] Forward test mode (paper trading toggle on dashboard)
- [x] Multi-pair backtest (7 pairs x 2yr M15 CSV data)
- [x] Settings persistence across restarts (DB to config on startup)
- [x] All 22 settings adjustable from dashboard (RSI, correlation, timeframes, paper mode)
- [x] Backtest panel (run from dashboard, view results/equity/trades)
- [x] Signals panel (webhook history, approved/rejected filter)
- [x] Close trade buttons functional (OANDA execution)
- [x] Close All + Modify Trade (SL/TP) endpoints
- [ ] Integrate ATS 4-strategy system (Standard, Aggressive, Scaling, DynamicProfitLevels) — needs AutoTrend rules
- [ ] Email/Telegram trade notifications
- [ ] VPS deployment + SSL + domain (required for TradingView webhooks)
